<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="application-name" content="Language Aid ‚Äì Pharmacy">
<meta name="msapplication-TileColor" content="#19478C">
<meta name="msapplication-config" content="none">
<meta name="theme-color" content="#19478C">
<title>Language Aid ‚Äì Pharmacy Setting (Part 1)</title>
<style>
  :root {
    --navy: #19478C;
    --sky: #3EB3E1;
    --teal: #009CA2;
    --white: #ffffff;
    --light: #f0f7fb;
    --grey: #e8eef3;
    --dark: #1a2a3a;
    --text: #2c3e50;
    --muted: #6b8099;
    --success: #27ae60;
    --warn: #e67e22;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: Tahoma, Geneva, Verdana, sans-serif;
    background: var(--light);
    color: var(--text);
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: linear-gradient(135deg, var(--navy) 0%, #1a5aad 60%, var(--sky) 100%);
    color: white;
    padding: 18px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 3px 12px rgba(25,71,140,0.3);
    position: sticky; top: 0; z-index: 100;
  }
  header .logo { display: flex; align-items: center; gap: 12px; }
  header .logo .icon {
    width: 44px; height: 44px;
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
  }
  header h1 { font-size: 1.2rem; font-weight: bold; letter-spacing: 0.3px; }
  header p { font-size: 0.75rem; opacity: 0.8; }
  #backBtn {
    background: rgba(255,255,255,0.18);
    border: 1px solid rgba(255,255,255,0.35);
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-family: Tahoma, sans-serif;
    font-size: 0.82rem;
    display: none;
    transition: background 0.2s;
    min-height: 44px;
    touch-action: manipulation;
    -ms-touch-action: manipulation;
  }
  #backBtn:hover { background: rgba(255,255,255,0.28); }

  /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
  .page { display: none; animation: fadeIn 0.35s ease; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* ‚îÄ‚îÄ LANGUAGE SELECT ‚îÄ‚îÄ */
  #langPage {
    max-width: 700px;
    margin: 60px auto;
    padding: 0 20px;
    text-align: center;
  }
  #langPage .hero-icon { font-size: 64px; margin-bottom: 20px; }
  #langPage h2 { font-size: 2rem; color: var(--navy); margin-bottom: 10px; }
  #langPage p { color: var(--muted); margin-bottom: 40px; font-size: 0.95rem; }
  .lang-cards { display: flex; gap: 24px; justify-content: center; flex-wrap: wrap; }
  .lang-card {
    background: white;
    border: 2px solid var(--grey);
    border-radius: 16px;
    padding: 40px 52px;
    cursor: pointer;
    transition: all 0.25s;
    min-width: 200px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    touch-action: manipulation;
    -ms-touch-action: manipulation;
  }
  .lang-card:hover {
    border-color: var(--sky);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(62,179,225,0.25);
  }
  .lang-card .flag { font-size: 48px; margin-bottom: 12px; }
  .lang-card h3 { color: var(--navy); font-size: 1.15rem; margin-bottom: 4px; }
  .lang-card span { color: var(--muted); font-size: 0.82rem; }

  /* ‚îÄ‚îÄ OVERALL PROGRESS ‚îÄ‚îÄ */
  .overall-progress {
    background: white;
    margin: 0 auto 28px;
    max-width: 900px;
    border-radius: 12px;
    padding: 18px 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .overall-progress h3 { font-size: 0.9rem; color: var(--navy); margin-bottom: 12px; }
  .module-indicators { display: flex; gap: 10px; flex-wrap: wrap; }
  .mod-badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: bold;
    border: 2px solid transparent;
  }
  .mod-badge.not-started { background: var(--grey); color: var(--muted); border-color: #d0dce6; }
  .mod-badge.in-progress { background: #fff3cd; color: #856404; border-color: #ffc107; }
  .mod-badge.completed { background: #d4edda; color: #155724; border-color: #28a745; }

  /* ‚îÄ‚îÄ MODULE SELECT ‚îÄ‚îÄ */
  #modulePage { padding: 28px 20px; }
  #modulePage .page-header { max-width: 900px; margin: 0 auto 20px; }
  #modulePage .page-header h2 { font-size: 1.5rem; color: var(--navy); }
  #modulePage .page-header p { color: var(--muted); font-size: 0.88rem; }
  .module-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 18px;
    max-width: 900px;
    margin: 0 auto;
  }
  .module-card {
    background: white;
    border-radius: 14px;
    padding: 26px;
    cursor: pointer;
    border: 2px solid var(--grey);
    transition: all 0.22s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
    touch-action: manipulation;
    -ms-touch-action: manipulation;
  }
  .module-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 5px; height: 100%;
    background: var(--sky);
    border-radius: 14px 0 0 14px;
  }
  .module-card:hover {
    border-color: var(--sky);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(62,179,225,0.2);
  }
  .module-card .m-icon { font-size: 28px; margin-bottom: 10px; }
  .module-card h3 { font-size: 1rem; color: var(--navy); margin-bottom: 4px; }
  .module-card p { font-size: 0.78rem; color: var(--muted); margin-bottom: 10px; }
  .module-card .status-badge {
    font-size: 0.72rem;
    padding: 3px 10px;
    border-radius: 12px;
    font-weight: bold;
    display: inline-block;
  }
  .status-not { background: var(--grey); color: var(--muted); }
  .status-progress { background: #fff3cd; color: #856404; }
  .status-done { background: #d4edda; color: #155724; }

  /* ‚îÄ‚îÄ LEARNING PAGE ‚îÄ‚îÄ */
  #learnPage { padding: 24px 20px; }
  .learn-container { max-width: 860px; margin: 0 auto; }
  .learn-header { margin-bottom: 22px; }
  .learn-header h2 { font-size: 1.4rem; color: var(--navy); }
  .learn-header p { color: var(--muted); font-size: 0.85rem; }

  /* Section progress bar */
  .section-progress-wrap { margin-bottom: 24px; }
  .section-progress-wrap label {
    display: flex; justify-content: space-between;
    font-size: 0.78rem; color: var(--muted); margin-bottom: 6px;
  }
  .progress-bar {
    height: 8px;
    background: var(--grey);
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--sky), var(--teal));
    border-radius: 4px;
    transition: width 0.4s ease;
  }

  /* Phrase cards */
  .phrase-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 28px; }
  .phrase-card {
    background: white;
    border-radius: 12px;
    padding: 16px 20px;
    border: 1px solid var(--grey);
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.05);
    transition: border-color 0.2s;
  }
  .phrase-card:hover { border-color: var(--sky); }
  .phrase-card .phrase-num {
    min-width: 30px;
    height: 30px;
    background: var(--navy);
    color: white;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
  }
  .phrase-card .phrase-text { flex: 1; }
  .phrase-card .phrase-text .english { font-size: 0.88rem; color: var(--muted); margin-bottom: 3px; }
  .phrase-card .phrase-text .translation { font-size: 1.05rem; color: var(--dark); font-weight: bold; }
  .phrase-card .phrase-text .romanized { font-size: 0.78rem; color: var(--teal); margin-top: 2px; font-style: italic; }
  .speak-btn {
    background: linear-gradient(135deg, var(--sky), var(--teal));
    border: none;
    color: white;
    width: 44px; height: 44px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.15s, opacity 0.15s;
    flex-shrink: 0;
    /* Ensure minimum touch target size per Microsoft guidelines */
    min-width: 44px; min-height: 44px;
    touch-action: manipulation;
    -ms-touch-action: manipulation;
  }
  .speak-btn.speaking {
    background: linear-gradient(135deg, var(--teal), var(--navy));
    animation: pulse 0.6s ease-in-out infinite alternate;
  }
  @keyframes pulse {
    from { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,156,162,0.4); }
    to   { transform: scale(1.12); box-shadow: 0 0 0 8px rgba(0,156,162,0); }
  }
  .phrase-card.seen { border-left: 4px solid var(--teal); }

  /* subsections */
  .subsection-title {
    background: linear-gradient(135deg, var(--navy), #1a5aad);
    color: white;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 0.88rem;
    margin-bottom: 10px;
    margin-top: 14px;
  }

  .quiz-btn {
    display: block;
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--navy), var(--sky));
    color: white;
    border: none;
    border-radius: 10px;
    font-family: Tahoma, sans-serif;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
    transition: opacity 0.2s, transform 0.15s;
  }
  .quiz-btn:hover { opacity: 0.9; transform: translateY(-1px); }

  /* ‚îÄ‚îÄ QUIZ PAGE ‚îÄ‚îÄ */
  #quizPage { padding: 28px 20px; }
  .quiz-container { max-width: 700px; margin: 0 auto; }
  .quiz-container h2 { font-size: 1.4rem; color: var(--navy); margin-bottom: 6px; }
  .quiz-container .quiz-meta { font-size: 0.82rem; color: var(--muted); margin-bottom: 24px; }

  .question-card {
    background: white;
    border-radius: 14px;
    padding: 28px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  .question-card .q-type {
    font-size: 0.72rem;
    color: var(--teal);
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
  }
  .question-card .q-text { font-size: 1.05rem; color: var(--dark); margin-bottom: 18px; font-weight: bold; }
  .question-card .audio-prompt {
    background: linear-gradient(135deg, var(--sky), var(--teal));
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-family: Tahoma, sans-serif;
    font-size: 0.9rem;
    margin-bottom: 20px;
    display: flex; align-items: center; gap: 8px;
    transition: opacity 0.2s;
  }
  .question-card .audio-prompt:hover { opacity: 0.85; }
  .options { display: flex; flex-direction: column; gap: 10px; }
  .option-btn {
    background: var(--light);
    border: 2px solid var(--grey);
    border-radius: 8px;
    padding: 14px 18px;
    cursor: pointer;
    font-family: Tahoma, sans-serif;
    font-size: 0.9rem;
    text-align: left;
    transition: all 0.18s;
    color: var(--text);
    min-height: 48px;
    touch-action: manipulation;
    -ms-touch-action: manipulation;
  }
  .option-btn:hover:not(:disabled) { border-color: var(--sky); background: #eef7fd; }
  .option-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
  .option-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }

  .quiz-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
  }
  .quiz-nav button {
    padding: 10px 22px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-family: Tahoma, sans-serif;
    font-size: 0.88rem;
    font-weight: bold;
    transition: opacity 0.2s;
  }
  #submitQuizBtn { background: var(--teal); color: white; }
  #submitQuizBtn:hover { opacity: 0.85; }

  .quiz-result {
    background: white;
    border-radius: 14px;
    padding: 36px;
    text-align: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  .quiz-result .score-circle {
    width: 100px; height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--sky), var(--teal));
    color: white;
    font-size: 1.6rem;
    font-weight: bold;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 18px;
  }
  .quiz-result h3 { font-size: 1.3rem; color: var(--navy); margin-bottom: 8px; }
  .quiz-result p { color: var(--muted); margin-bottom: 22px; }
  .quiz-result button {
    background: linear-gradient(135deg, var(--navy), var(--sky));
    color: white;
    border: none;
    padding: 12px 28px;
    border-radius: 8px;
    cursor: pointer;
    font-family: Tahoma, sans-serif;
    font-size: 0.95rem;
    font-weight: bold;
    margin: 0 6px;
  }

  /* Numbers grid */
  .numbers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
    margin-bottom: 28px;
  }
  .num-card {
    background: white;
    border-radius: 10px;
    border: 1px solid var(--grey);
    padding: 14px;
    text-align: center;
    cursor: pointer;
    transition: all 0.18s;
  }
  .num-card:hover { border-color: var(--sky); box-shadow: 0 4px 12px rgba(62,179,225,0.2); }
  .num-card .num-en { font-size: 0.75rem; color: var(--muted); }
  .num-card .num-digit { font-size: 1.6rem; font-weight: bold; color: var(--navy); }
  .num-card .num-trans { font-size: 0.95rem; color: var(--dark); font-weight: bold; margin-top: 2px; }
  .num-card .num-rom { font-size: 0.72rem; color: var(--teal); font-style: italic; }

  /* Responsive */
  @media (max-width: 600px) {
    header h1 { font-size: 1rem; }
    .lang-card { padding: 24px 32px; }
    #langPage h2 { font-size: 1.5rem; }
  }

  /* ‚îÄ‚îÄ EDGE / SURFACE TOUCH OPTIMISATIONS ‚îÄ‚îÄ */
  /* Coarse pointer = touchscreen (Surface, tablet, phone) */
  @media (pointer: coarse) {
    .phrase-card { padding: 18px 20px; gap: 18px; }
    .num-card { padding: 18px; }
    .module-card { padding: 28px; }
    .speak-btn { width: 48px; height: 48px; min-width: 48px; min-height: 48px; }
    .option-btn { padding: 16px 18px; font-size: 0.95rem; }
    .quiz-btn { padding: 16px; font-size: 1.05rem; }
    .cond-tab { padding: 10px 20px; font-size: 0.85rem; }
    .lang-card { padding: 44px 56px; }
  }

  /* Edge scrollbar styling */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--grey); }
  ::-webkit-scrollbar-thumb { background: var(--sky); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--teal); }

  .lang-flag-text { font-size: 0.7rem; opacity: 0.7; margin-top: 4px; }

  /* Condition sub-nav */
  .conditions-tabs {
    display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 18px;
  }
  .cond-tab {
    background: white;
    border: 2px solid var(--grey);
    border-radius: 20px;
    padding: 8px 18px;
    cursor: pointer;
    font-size: 0.82rem;
    font-family: Tahoma, sans-serif;
    color: var(--navy);
    transition: all 0.18s;
    min-height: 40px;
    touch-action: manipulation;
    -ms-touch-action: manipulation;
  }
  .cond-tab:hover, .cond-tab.active { background: var(--navy); color: white; border-color: var(--navy); }
</style>
<!-- edge-tts-universal: Microsoft neural TTS, no API key needed, works in any browser -->
<script src="https://cdn.jsdelivr.net/npm/edge-tts-universal/dist/browser.umd.js"
        onload="_initEdgeTTS()"
        onerror="console.warn('edge-tts CDN unavailable, using Web Speech fallback')">
</script>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="icon">üíä</div>
    <div>
      <h1>Language Aid ‚Äì Pharmacy Setting</h1>
      <p>Part 1 ¬∑ Multilingual Communication Tool</p>
    </div>
  </div>
  <button id="backBtn" onclick="goBack()">‚Üê Back</button>
</header>

<!-- AUDIO STATUS BANNER -->
<div id="audioBanner" style="display:none; background:#e8f4fd; border-bottom:2px solid #3EB3E1; padding:10px 24px; font-size:0.82rem; color:#19478C; text-align:center;">
  üåê Audio requires an internet connection to stream Microsoft neural voices. Make sure you are online and try again.
</div>

<!-- PAGE: Language Selection -->
<div id="langPage" class="page active">
  <div class="hero-icon">üåè</div>
  <h2>Select a Language</h2>
  <p>Choose the language you would like to learn pharmacy phrases in.</p>
  <div class="lang-cards">
    <div class="lang-card" onclick="selectLang('mandarin')">
      <div class="flag">üá®üá≥</div>
      <h3>Mandarin</h3>
      <span>ÊôÆÈÄöËØù</span>
      <div class="lang-flag-text">Simplified Chinese</div>
    </div>
    <div class="lang-card" onclick="selectLang('malay')">
      <div class="flag">üá≤üáæ</div>
      <h3>Malay</h3>
      <span>Bahasa Melayu</span>
      <div class="lang-flag-text">Malaysian Malay</div>
    </div>
  </div>
</div>

<!-- PAGE: Module Selection -->
<div id="modulePage" class="page">
  <div class="page-header">
    <h2 id="modulePageTitle">Modules</h2>
    <p>Select a module to begin learning</p>
  </div>
  <div id="overallProgress" class="overall-progress">
    <h3>üìä Your Progress</h3>
    <div id="moduleIndicators" class="module-indicators"></div>
  </div>
  <div class="module-grid" id="moduleGrid"></div>
</div>

<!-- PAGE: Learning -->
<div id="learnPage" class="page">
  <div class="learn-container">
    <div class="learn-header">
      <h2 id="learnTitle"></h2>
      <p id="learnSubtitle"></p>
    </div>
    <div class="section-progress-wrap">
      <label><span>Section Progress</span><span id="progressLabel">0%</span></label>
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    </div>
    <div id="learnContent"></div>
    <button class="quiz-btn" onclick="startQuiz()">üìù Take Quiz for This Module</button>
  </div>
</div>

<!-- PAGE: Quiz -->
<div id="quizPage" class="page">
  <div class="quiz-container">
    <h2>üìù Module Quiz</h2>
    <p class="quiz-meta" id="quizMeta"></p>
    <div id="quizContent"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CONTENT = {
  mandarin: {
    lang: 'zh-CN',
    label: 'Mandarin (ÊôÆÈÄöËØù)',
    modules: [
      {
        id: 'greetings',
        title: 'Greetings',
        icon: 'üëã',
        desc: '8 essential greeting phrases',
        type: 'phrases',
        items: [
          { en: 'Good morning', t: 'Êó©‰∏äÂ•Ω', r: 'Z«éoshang h«éo' },
          { en: 'Good afternoon', t: '‰∏ãÂçàÂ•Ω', r: 'Xi√†w«î h«éo' },
          { en: 'Good evening', t: 'Êôö‰∏äÂ•Ω', r: 'W«énshang h«éo' },
          { en: 'Hi, what can I help you with?', t: 'ÊÇ®Â•ΩÔºåÊàëÂèØ‰ª•Â∏ÆÊÇ®‰ªÄ‰πàÔºü', r: 'N√≠n h«éo, w«í kƒõy«ê bƒÅng n√≠n sh√©nme?' },
          { en: 'May I have your name & NRIC number?', t: 'ËØ∑ÈóÆÊÇ®ÁöÑÂßìÂêçÂíåË∫´‰ªΩËØÅÂè∑Á†ÅÔºü', r: 'Q«êngw√®n n√≠n de x√¨ngm√≠ng h√© shƒìnf√®n zh√®ng h√†om«é?' },
          { en: 'Do you have any allergies?', t: 'ÊÇ®ÊúâËøáÊïèÁóáÂêóÔºü', r: 'N√≠n y«íu gu√≤m«ên zh√®ng ma?' },
          { en: 'Please take a seat first and wait for the same queue number.', t: 'ËØ∑ÂÖàÂùê‰∏ãÔºåÁ≠âÂè´ÊÇ®ÁöÑÂè∑Á†Å„ÄÇ', r: 'Q«êng xiƒÅn zu√≤ xia, dƒõng ji√†o n√≠n de h√†om«é.' },
          { en: 'Thank you.', t: 'Ë∞¢Ë∞¢„ÄÇ', r: 'Xi√®xi√®.' }
        ]
      },
      {
        id: 'numbers',
        title: 'Numbers',
        icon: 'üî¢',
        desc: 'Numbers 1 to 20',
        type: 'numbers',
        items: [
          { en: 'One', n: 1, t: '‰∏Ä', r: 'Yƒ´' },
          { en: 'Two', n: 2, t: '‰∫å', r: '√àr' },
          { en: 'Three', n: 3, t: '‰∏â', r: 'SƒÅn' },
          { en: 'Four', n: 4, t: 'Âõõ', r: 'S√¨' },
          { en: 'Five', n: 5, t: '‰∫î', r: 'W«î' },
          { en: 'Six', n: 6, t: 'ÂÖ≠', r: 'Li√π' },
          { en: 'Seven', n: 7, t: '‰∏É', r: 'Qƒ´' },
          { en: 'Eight', n: 8, t: 'ÂÖ´', r: 'BƒÅ' },
          { en: 'Nine', n: 9, t: '‰πù', r: 'Ji«î' },
          { en: 'Ten', n: 10, t: 'ÂçÅ', r: 'Sh√≠' },
          { en: 'Eleven', n: 11, t: 'ÂçÅ‰∏Ä', r: 'Sh√≠yƒ´' },
          { en: 'Twelve', n: 12, t: 'ÂçÅ‰∫å', r: 'Sh√≠\'√®r' },
          { en: 'Thirteen', n: 13, t: 'ÂçÅ‰∏â', r: 'Sh√≠sƒÅn' },
          { en: 'Fourteen', n: 14, t: 'ÂçÅÂõõ', r: 'Sh√≠s√¨' },
          { en: 'Fifteen', n: 15, t: 'ÂçÅ‰∫î', r: 'Sh√≠w«î' },
          { en: 'Sixteen', n: 16, t: 'ÂçÅÂÖ≠', r: 'Sh√≠li√π' },
          { en: 'Seventeen', n: 17, t: 'ÂçÅ‰∏É', r: 'Sh√≠qƒ´' },
          { en: 'Eighteen', n: 18, t: 'ÂçÅÂÖ´', r: 'Sh√≠bƒÅ' },
          { en: 'Nineteen', n: 19, t: 'ÂçÅ‰πù', r: 'Sh√≠ji«î' },
          { en: 'Twenty', n: 20, t: '‰∫åÂçÅ', r: '√àrsh√≠' }
        ]
      },
      {
        id: 'frequency',
        title: 'Frequency & Duration',
        icon: '‚è∞',
        desc: '13 time & frequency terms',
        type: 'phrases',
        items: [
          { en: 'Morning', t: 'Êó©‰∏ä', r: 'Z«éoshang' },
          { en: 'Afternoon', t: '‰∏ãÂçà', r: 'Xi√†w«î' },
          { en: 'Evening', t: 'ÂÇçÊôö', r: 'B√†ngw«én' },
          { en: 'Night', t: 'Êôö‰∏ä', r: 'W«énshang' },
          { en: 'Day', t: 'Â§©', r: 'TiƒÅn' },
          { en: 'Hour', t: 'Â∞èÊó∂', r: 'Xi«éosh√≠' },
          { en: 'Week', t: 'Âë®', r: 'Zh≈çu' },
          { en: 'Month', t: 'Êúà', r: 'Yu√®' },
          { en: 'Year', t: 'Âπ¥', r: 'Ni√°n' },
          { en: 'Half', t: 'Âçä', r: 'B√†n' },
          { en: 'Alternate day', t: 'ÈöîÂ§©', r: 'G√© tiƒÅn' },
          { en: 'Before food', t: 'È•≠Ââç', r: 'F√†n qi√°n' },
          { en: 'After food', t: 'È•≠Âêé', r: 'F√†n h√≤u' }
        ]
      },
      {
        id: 'dispensing',
        title: 'Dispensing Phrases',
        icon: 'üí¨',
        desc: '13 commonly used dispensing phrases',
        type: 'phrases',
        items: [
          { en: 'Take one tablet two times a day.', t: 'ÊØèÂ§©ÊúçÁî®‰∏ÄÁâáÔºå‰∏ÄÂ§©‰∏§Ê¨°„ÄÇ', r: 'MƒõitiƒÅn f√∫y√≤ng yƒ´ pi√†n, yƒ´tiƒÅn li«éng c√¨.' },
          { en: 'With food', t: 'ÈöèÈ§êÊúçÁî®', r: 'Su√≠ cƒÅn f√∫y√≤ng' },
          { en: 'Without food', t: 'Á©∫ËÖπÊúçÁî®', r: 'K≈çngf√π f√∫y√≤ng' },
          { en: 'Take this on an empty stomach.', t: 'ËØ∑Á©∫ËÖπÊúçÁî®Ê≠§ËçØ„ÄÇ', r: 'Q«êng k≈çngf√π f√∫y√≤ng c«ê y√†o.' },
          { en: 'Complete the full course even if you feel better.', t: 'Âç≥‰ΩøÊÑüËßâÂ•ΩËΩ¨Ôºå‰πüË¶ÅÂÆåÊàêÊï¥‰∏™ÁñóÁ®ã„ÄÇ', r: 'J√≠sh«ê g«énju√© h«éozhu«én, yƒõ y√†o w√°nch√©ng zhƒõngg√® li√°och√©ng.' },
          { en: 'Take with plenty of water.', t: 'ÊúçËçØÊó∂ËØ∑Â§öÂñùÊ∞¥„ÄÇ', r: 'F√∫ y√†o sh√≠ q«êng du≈ç hƒì shu«ê.' },
          { en: 'Store in a cool, dry place.', t: 'ËØ∑Â≠òÊîæÂú®Èò¥ÂáâÂπ≤Áá•Â§Ñ„ÄÇ', r: 'Q«êng c√∫nf√†ng z√†i yƒ´nli√°ng gƒÅnz√†o ch√π.' },
          { en: 'Avoid alcohol.', t: 'ËØ∑ÂãøÈ•ÆÈÖí„ÄÇ', r: 'Q«êng w√π y«ênji«î.' },
          { en: 'This may cause drowsiness.', t: 'Ê≠§ËçØÂèØËÉΩ‰ºöÂØºËá¥ÂóúÁù°„ÄÇ', r: 'C«ê y√†o kƒõn√©ng hu√¨ d«éozh√¨ sh√¨shu√¨.' },
          { en: 'Avoid driving or operating machinery.', t: 'ËØ∑ÂãøÈ©æËΩ¶ÊàñÊìç‰ΩúÊú∫Ê¢∞„ÄÇ', r: 'Q«êng w√π ji√†chƒì hu√≤ cƒÅozu√≤ jƒ´xi√®.' },
          { en: 'This medication needs to be stored in the fridge.', t: 'Ê≠§ËçØÈúÄÂÜ∑Ëóè‰øùÂ≠ò„ÄÇ', r: 'C«ê y√†o x≈´ lƒõngc√°ng b«éoc√∫n.' },
          { en: "If you forget a dose, take it as soon as you remember unless it's nearly time for the next one.", t: 'Â¶ÇÊûúÂøòËÆ∞ÊúçËçØÔºåËØ∑Â∞ΩÂø´Ë°•ÊúçÔºå‰ΩÜËã•Êé•Ëøë‰∏ãÊ¨°ÊúçËçØÊó∂Èó¥ÂàôË∑≥Ëøá„ÄÇ', r: 'R√∫gu«í w√†ngj√¨ f√∫ y√†o, q«êng j«ên ku√†i b«î f√∫, d√†n ru√≤ jiƒìj√¨n xi√† c√¨ f√∫ y√†o sh√≠jiƒÅn z√© ti√†ogu√≤.' },
          { en: 'Take one tablet one time a day at the same time everyday.', t: 'ÊØèÂ§©Âêå‰∏ÄÊó∂Èó¥ÊúçÁî®‰∏ÄÁâáÔºå‰∏ÄÂ§©‰∏ÄÊ¨°„ÄÇ', r: 'MƒõitiƒÅn t√≥ngyƒ´ sh√≠jiƒÅn f√∫y√≤ng yƒ´ pi√†n, yƒ´tiƒÅn yƒ´ c√¨.' }
        ]
      },
      {
        id: 'conditions',
        title: 'Conditions',
        icon: 'üè•',
        desc: 'Medical conditions A‚ÄìZ',
        type: 'conditions',
        subs: [
          {
            label: 'A',
            items: [
              { en: 'Allergy', t: 'ËøáÊïè', r: 'Gu√≤m«ên' },
              { en: 'Asthma', t: 'ÂìÆÂñò', r: 'XiƒÅochu«én' },
              { en: 'Arthritis', t: 'ÂÖ≥ËäÇÁÇé', r: 'GuƒÅnji√©y√°n' },
              { en: 'Anxiety', t: 'ÁÑ¶ËôëÁóá', r: 'JiƒÅol«ú zh√®ng' },
            ]
          },
          {
            label: 'B',
            items: [
              { en: 'Blood pressure (high)', t: 'È´òË°ÄÂéã', r: 'GƒÅo xu√®yƒÅ' },
              { en: 'Blood pressure (low)', t: '‰ΩéË°ÄÂéã', r: 'Dƒ´ xu√®yƒÅ' },
            ]
          },
          {
            label: 'C',
            items: [
              { en: 'Cough', t: 'Âí≥ÂóΩ', r: 'K√©s√≤u' },
              { en: 'Cold', t: 'ÊÑüÂÜí', r: 'G«énm√†o' },
              { en: 'Constipation', t: '‰æøÁßò', r: 'Bi√†nm√¨' },
              { en: 'Cholesterol (high)', t: 'È´òËÉÜÂõ∫ÈÜá', r: 'GƒÅo d«éng√πch√∫n' },
            ]
          },
          {
            label: 'D',
            items: [
              { en: 'Diabetes', t: 'Á≥ñÂ∞øÁóÖ', r: 'T√°ngni√†ob√¨ng' },
              { en: 'Diarrhoea', t: 'ËÖπÊ≥ª', r: 'F√πxi√®' },
              { en: 'Dizziness', t: 'Â§¥Êôï', r: 'T√≥uy≈´n' },
            ]
          },
          {
            label: 'E-F',
            items: [
              { en: 'Eczema', t: 'ÊπøÁñπ', r: 'Shƒ´zhƒõn' },
              { en: 'Fever', t: 'ÂèëÁÉß', r: 'FƒÅshƒÅo' },
              { en: 'Fungal infection', t: 'ÁúüËèåÊÑüÊüì', r: 'Zhƒìnj≈´n g«énr«én' },
            ]
          },
          {
            label: 'G-H',
            items: [
              { en: 'Gastric pain', t: 'ËÉÉÁóõ', r: 'W√®it√≤ng' },
              { en: 'Headache', t: 'Â§¥Áóõ', r: 'T√≥ut√≤ng' },
              { en: 'Heart disease', t: 'ÂøÉËÑèÁóÖ', r: 'Xƒ´nz√†ngb√¨ng' },
            ]
          },
          {
            label: 'I-P',
            items: [
              { en: 'Infection', t: 'ÊÑüÊüì', r: 'G«énr«én' },
              { en: 'Insomnia', t: 'Â§±Áú†', r: 'Shƒ´mi√°n' },
              { en: 'Nausea', t: 'ÊÅ∂ÂøÉ', r: 'ƒöxƒ´n' },
              { en: 'Pain', t: 'ÁñºÁóõ', r: 'T√©ngt√≤ng' },
            ]
          },
          {
            label: 'S-V',
            items: [
              { en: 'Skin rash', t: 'ÁöÆÁñπ', r: 'P√≠zhƒõn' },
              { en: 'Sore throat', t: 'ÂñâÂíôÁóõ', r: 'H√≥ul√≥ng t√≤ng' },
              { en: 'Thyroid disorder', t: 'Áî≤Áä∂ËÖ∫ÁñæÁóÖ', r: 'Ji«ézhu√†ngxi√†n j√≠b√¨ng' },
              { en: 'Urinary tract infection', t: 'Â∞øÈÅìÊÑüÊüì', r: 'Ni√†od√†o g«énr«én' },
              { en: 'Vomiting', t: 'ÂëïÂêê', r: '«ëut√π' },
            ]
          }
        ]
      }
    ]
  },
  malay: {
    lang: 'ms-MY',
    label: 'Malay (Bahasa Melayu)',
    modules: [
      {
        id: 'greetings',
        title: 'Greetings',
        icon: 'üëã',
        desc: '8 essential greeting phrases',
        type: 'phrases',
        items: [
          { en: 'Good morning', t: 'Selamat pagi', r: '' },
          { en: 'Good afternoon', t: 'Selamat tengah hari', r: '' },
          { en: 'Good evening', t: 'Selamat petang', r: '' },
          { en: 'Hi, what can I help you with?', t: 'Hai, apa yang boleh saya bantu?', r: '' },
          { en: 'May I have your name & NRIC number?', t: 'Boleh saya dapatkan nama dan nombor NRIC anda?', r: '' },
          { en: 'Do you have any allergies?', t: 'Adakah anda mempunyai sebarang alahan?', r: '' },
          { en: 'Please take a seat first and wait for the same queue number.', t: 'Sila duduk dahulu dan tunggu nombor giliran yang sama.', r: '' },
          { en: 'Thank you.', t: 'Terima kasih.', r: '' }
        ]
      },
      {
        id: 'numbers',
        title: 'Numbers',
        icon: 'üî¢',
        desc: 'Numbers 1 to 20',
        type: 'numbers',
        items: [
          { en: 'One', n: 1, t: 'Satu', r: '' },
          { en: 'Two', n: 2, t: 'Dua', r: '' },
          { en: 'Three', n: 3, t: 'Tiga', r: '' },
          { en: 'Four', n: 4, t: 'Empat', r: '' },
          { en: 'Five', n: 5, t: 'Lima', r: '' },
          { en: 'Six', n: 6, t: 'Enam', r: '' },
          { en: 'Seven', n: 7, t: 'Tujuh', r: '' },
          { en: 'Eight', n: 8, t: 'Lapan', r: '' },
          { en: 'Nine', n: 9, t: 'Sembilan', r: '' },
          { en: 'Ten', n: 10, t: 'Sepuluh', r: '' },
          { en: 'Eleven', n: 11, t: 'Sebelas', r: '' },
          { en: 'Twelve', n: 12, t: 'Dua belas', r: '' },
          { en: 'Thirteen', n: 13, t: 'Tiga belas', r: '' },
          { en: 'Fourteen', n: 14, t: 'Empat belas', r: '' },
          { en: 'Fifteen', n: 15, t: 'Lima belas', r: '' },
          { en: 'Sixteen', n: 16, t: 'Enam belas', r: '' },
          { en: 'Seventeen', n: 17, t: 'Tujuh belas', r: '' },
          { en: 'Eighteen', n: 18, t: 'Lapan belas', r: '' },
          { en: 'Nineteen', n: 19, t: 'Sembilan belas', r: '' },
          { en: 'Twenty', n: 20, t: 'Dua puluh', r: '' }
        ]
      },
      {
        id: 'frequency',
        title: 'Frequency & Duration',
        icon: '‚è∞',
        desc: '13 time & frequency terms',
        type: 'phrases',
        items: [
          { en: 'Morning', t: 'Pagi', r: '' },
          { en: 'Afternoon', t: 'Tengah hari', r: '' },
          { en: 'Evening', t: 'Petang', r: '' },
          { en: 'Night', t: 'Malam', r: '' },
          { en: 'Day', t: 'Hari', r: '' },
          { en: 'Hour', t: 'Jam', r: '' },
          { en: 'Week', t: 'Minggu', r: '' },
          { en: 'Month', t: 'Bulan', r: '' },
          { en: 'Year', t: 'Tahun', r: '' },
          { en: 'Half', t: 'Separuh', r: '' },
          { en: 'Alternate day', t: 'Setiap dua hari', r: '' },
          { en: 'Before food', t: 'Sebelum makan', r: '' },
          { en: 'After food', t: 'Selepas makan', r: '' }
        ]
      },
      {
        id: 'dispensing',
        title: 'Dispensing Phrases',
        icon: 'üí¨',
        desc: '13 commonly used dispensing phrases',
        type: 'phrases',
        items: [
          { en: 'Take one tablet two times a day.', t: 'Ambil satu tablet dua kali sehari.', r: '' },
          { en: 'With food', t: 'Bersama makanan', r: '' },
          { en: 'Without food', t: 'Tanpa makanan', r: '' },
          { en: 'Take this on an empty stomach.', t: 'Ambil ubat ini ketika perut kosong.', r: '' },
          { en: 'Complete the full course even if you feel better.', t: 'Habiskan keseluruhan kursus walaupun anda berasa lebih baik.', r: '' },
          { en: 'Take with plenty of water.', t: 'Ambil dengan banyak air.', r: '' },
          { en: 'Store in a cool, dry place.', t: 'Simpan di tempat yang sejuk dan kering.', r: '' },
          { en: 'Avoid alcohol.', t: 'Elakkan alkohol.', r: '' },
          { en: 'This may cause drowsiness.', t: 'Ini mungkin menyebabkan mengantuk.', r: '' },
          { en: 'Avoid driving or operating machinery.', t: 'Elakkan memandu atau mengendalikan mesin.', r: '' },
          { en: 'This medication needs to be stored in the fridge.', t: 'Ubat ini perlu disimpan di dalam peti sejuk.', r: '' },
          { en: "If you forget a dose, take it as soon as you remember unless it's nearly time for the next one.", t: 'Jika anda terlupa dos, ambillah sebaik sahaja anda ingat melainkan hampir tiba masa dos berikutnya.', r: '' },
          { en: 'Take one tablet one time a day at the same time everyday.', t: 'Ambil satu tablet sekali sehari pada waktu yang sama setiap hari.', r: '' }
        ]
      },
      {
        id: 'conditions',
        title: 'Conditions',
        icon: 'üè•',
        desc: 'Medical conditions A‚ÄìZ',
        type: 'conditions',
        subs: [
          {
            label: 'A',
            items: [
              { en: 'Allergy', t: 'Alahan', r: '' },
              { en: 'Asthma', t: 'Lelah / Asma', r: '' },
              { en: 'Arthritis', t: 'Artritis / Radang sendi', r: '' },
              { en: 'Anxiety', t: 'Kebimbangan', r: '' },
            ]
          },
          {
            label: 'B',
            items: [
              { en: 'Blood pressure (high)', t: 'Tekanan darah tinggi', r: '' },
              { en: 'Blood pressure (low)', t: 'Tekanan darah rendah', r: '' },
            ]
          },
          {
            label: 'C',
            items: [
              { en: 'Cough', t: 'Batuk', r: '' },
              { en: 'Cold', t: 'Selesema', r: '' },
              { en: 'Constipation', t: 'Sembelit', r: '' },
              { en: 'Cholesterol (high)', t: 'Kolesterol tinggi', r: '' },
            ]
          },
          {
            label: 'D',
            items: [
              { en: 'Diabetes', t: 'Kencing manis / Diabetes', r: '' },
              { en: 'Diarrhoea', t: 'Cirit-birit', r: '' },
              { en: 'Dizziness', t: 'Pening / Loya kepala', r: '' },
            ]
          },
          {
            label: 'E-F',
            items: [
              { en: 'Eczema', t: 'Ekzema', r: '' },
              { en: 'Fever', t: 'Demam', r: '' },
              { en: 'Fungal infection', t: 'Jangkitan kulat', r: '' },
            ]
          },
          {
            label: 'G-H',
            items: [
              { en: 'Gastric pain', t: 'Sakit gastrik', r: '' },
              { en: 'Headache', t: 'Sakit kepala', r: '' },
              { en: 'Heart disease', t: 'Penyakit jantung', r: '' },
            ]
          },
          {
            label: 'I-P',
            items: [
              { en: 'Infection', t: 'Jangkitan', r: '' },
              { en: 'Insomnia', t: 'Insomnia / Tidak boleh tidur', r: '' },
              { en: 'Nausea', t: 'Loya / Mual', r: '' },
              { en: 'Pain', t: 'Sakit / Kesakitan', r: '' },
            ]
          },
          {
            label: 'S-V',
            items: [
              { en: 'Skin rash', t: 'Ruam kulit', r: '' },
              { en: 'Sore throat', t: 'Sakit tekak', r: '' },
              { en: 'Thyroid disorder', t: 'Masalah tiroid', r: '' },
              { en: 'Urinary tract infection', t: 'Jangkitan saluran kencing', r: '' },
              { en: 'Vomiting', t: 'Muntah', r: '' },
            ]
          }
        ]
      }
    ]
  }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentLang = null;
let currentModuleIdx = null;
let progress = {}; // { mandarin: { greetings: { seen: Set, quizDone: bool, score: n } } }
let quizQuestions = [];
let quizAnswers = [];
let currentQuizModule = null;
let navStack = [];

function getProgress(lang, moduleId) {
  if (!progress[lang]) progress[lang] = {};
  if (!progress[lang][moduleId]) progress[lang][moduleId] = { seen: new Set(), quizDone: false, score: 0 };
  return progress[lang][moduleId];
}

function getModuleStatus(lang, moduleId, totalItems) {
  const p = getProgress(lang, moduleId);
  if (p.quizDone) return 'completed';
  if (p.seen.size > 0) return 'in-progress';
  return 'not-started';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NAVIGATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const backBtn = document.getElementById('backBtn');
  backBtn.style.display = id === 'langPage' ? 'none' : 'block';
}

function goBack() {
  if (navStack.length > 0) {
    const prev = navStack.pop();
    prev();
  } else {
    showLangPage();
  }
}

function showLangPage() {
  navStack = [];
  currentLang = null;
  showPage('langPage');
}

function selectLang(lang) {
  currentLang = lang;
  navStack = [showLangPage];
  showModulePage();
}

function showModulePage() {
  const data = CONTENT[currentLang];
  document.getElementById('modulePageTitle').textContent = data.label + ' ‚Äî Modules';
  renderModuleGrid();
  renderOverallProgress();
  showPage('modulePage');
}

function renderOverallProgress() {
  const data = CONTENT[currentLang];
  const container = document.getElementById('moduleIndicators');
  container.innerHTML = '';
  data.modules.forEach(mod => {
    const allItems = mod.type === 'conditions'
      ? mod.subs.flatMap(s => s.items)
      : mod.items;
    const status = getModuleStatus(currentLang, mod.id, allItems.length);
    const badge = document.createElement('span');
    badge.className = 'mod-badge ' + (status === 'completed' ? 'completed' : status === 'in-progress' ? 'in-progress' : 'not-started');
    badge.textContent = (status === 'completed' ? '‚úì ' : status === 'in-progress' ? '‚ü≥ ' : '‚óã ') + mod.title;
    container.appendChild(badge);
  });
}

function renderModuleGrid() {
  const data = CONTENT[currentLang];
  const grid = document.getElementById('moduleGrid');
  grid.innerHTML = '';
  data.modules.forEach((mod, idx) => {
    const allItems = mod.type === 'conditions'
      ? mod.subs.flatMap(s => s.items)
      : mod.items;
    const status = getModuleStatus(currentLang, mod.id, allItems.length);
    const card = document.createElement('div');
    card.className = 'module-card';
    card.innerHTML = `
      <div class="m-icon">${mod.icon}</div>
      <h3>${mod.title}</h3>
      <p>${mod.desc}</p>
      <span class="status-badge ${status === 'completed' ? 'status-done' : status === 'in-progress' ? 'status-progress' : 'status-not'}">
        ${status === 'completed' ? '‚úì Completed' : status === 'in-progress' ? '‚ü≥ In Progress' : '‚óã Not Started'}
      </span>
    `;
    card.onclick = () => openModule(idx);
    grid.appendChild(card);
  });
}

function openModule(idx) {
  currentModuleIdx = idx;
  const mod = CONTENT[currentLang].modules[idx];
  navStack.push(showModulePage);
  renderLearnPage(mod);
  showPage('learnPage');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LEARNING PAGE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLearnPage(mod) {
  document.getElementById('learnTitle').textContent = mod.icon + ' ' + mod.title;
  document.getElementById('learnSubtitle').textContent = CONTENT[currentLang].label;
  const container = document.getElementById('learnContent');
  container.innerHTML = '';

  const allItems = mod.type === 'conditions' ? mod.subs.flatMap(s => s.items) : mod.items;
  const p = getProgress(currentLang, mod.id);
  updateProgressBar(p.seen.size, allItems.length);

  if (mod.type === 'phrases') {
    renderPhraseList(container, mod.items, mod.id);
  } else if (mod.type === 'numbers') {
    renderNumbers(container, mod.items, mod.id);
  } else if (mod.type === 'conditions') {
    renderConditions(container, mod.subs, mod.id);
  }
}

function updateProgressBar(seen, total) {
  const pct = total > 0 ? Math.round((seen / total) * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressLabel').textContent = pct + '%';
}

function markSeen(moduleId, key) {
  const p = getProgress(currentLang, moduleId);
  p.seen.add(key);
  const mod = CONTENT[currentLang].modules.find(m => m.id === moduleId);
  const allItems = mod.type === 'conditions' ? mod.subs.flatMap(s => s.items) : mod.items;
  updateProgressBar(p.seen.size, allItems.length);
}

function renderPhraseList(container, items, moduleId) {
  const list = document.createElement('div');
  list.className = 'phrase-list';
  items.forEach((item, i) => {
    const card = createPhraseCard(item, i, moduleId, item.t);
    list.appendChild(card);
  });
  container.appendChild(list);
}

function createPhraseCard(item, i, moduleId, speakText) {
  const p = getProgress(currentLang, moduleId);
  const card = document.createElement('div');
  card.className = 'phrase-card' + (p.seen.has(i.toString()) ? ' seen' : '');
  const langCode = CONTENT[currentLang].lang;
  card.innerHTML = `
    <div class="phrase-num">${i + 1}</div>
    <div class="phrase-text">
      <div class="english">${item.en}</div>
      <div class="translation">${item.t}</div>
      ${item.r ? `<div class="romanized">${item.r}</div>` : ''}
    </div>
    <button class="speak-btn" title="Listen to pronunciation">üîä</button>
  `;
  const speakBtn = card.querySelector('.speak-btn');
  speakBtn.addEventListener('click', () => {
    // Visual feedback: animate button while speaking
    speakBtn.classList.add('speaking');
    speakBtn.textContent = 'üîâ';
    const utter_check = window.speechSynthesis;
    speak(speakText, langCode);
    // Remove speaking state after estimated duration (avg ~2s per short phrase)
    const resetBtn = () => {
      speakBtn.classList.remove('speaking');
      speakBtn.textContent = 'üîä';
    };
    const estDuration = Math.max(1500, speakText.length * 120);
    setTimeout(resetBtn, estDuration);
    markSeen(moduleId, i.toString());
    card.classList.add('seen');
  });
  return card;
}

function renderNumbers(container, items, moduleId) {
  const grid = document.createElement('div');
  grid.className = 'numbers-grid';
  const langCode = CONTENT[currentLang].lang;
  items.forEach((item, i) => {
    const card = document.createElement('div');
    card.className = 'num-card';
    card.innerHTML = `
      <div class="num-en">${item.en}</div>
      <div class="num-digit">${item.n}</div>
      <div class="num-trans">${item.t}</div>
      ${item.r ? `<div class="num-rom">${item.r}</div>` : ''}
      <div style="font-size:0.75rem;color:var(--teal);margin-top:6px;">üîä tap to listen</div>
    `;
    card.addEventListener('click', () => {
      speak(item.t, langCode);
      markSeen(moduleId, i.toString());
      card.style.borderColor = 'var(--teal)';
      card.style.background = '#eef9f9';
    });
    grid.appendChild(card);
  });
  container.appendChild(grid);
}

function renderConditions(container, subs, moduleId) {
  // Tabs
  const tabs = document.createElement('div');
  tabs.className = 'conditions-tabs';
  const contentArea = document.createElement('div');

  subs.forEach((sub, si) => {
    const tab = document.createElement('button');
    tab.className = 'cond-tab' + (si === 0 ? ' active' : '');
    tab.textContent = sub.label;
    tab.addEventListener('click', () => {
      tabs.querySelectorAll('.cond-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderConditionSub(contentArea, sub, moduleId, subs[0]);
      // offset seen index
    });
    tabs.appendChild(tab);
  });
  container.appendChild(tabs);
  container.appendChild(contentArea);

  // Render first tab
  renderConditionSub(contentArea, subs[0], moduleId, subs[0]);
}

function renderConditionSub(container, sub, moduleId, firstSub) {
  container.innerHTML = '';
  const allSubs = CONTENT[currentLang].modules.find(m => m.id === moduleId).subs;
  const list = document.createElement('div');
  list.className = 'phrase-list';
  let offset = 0;
  allSubs.forEach(s => {
    if (s.label === sub.label) return;
    if (allSubs.indexOf(s) < allSubs.indexOf(sub)) offset += s.items.length;
  });
  sub.items.forEach((item, i) => {
    const globalIdx = offset + i;
    const card = createPhraseCard(item, globalIdx, moduleId, item.t);
    list.appendChild(card);
  });
  container.appendChild(list);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SPEECH ‚Äî edge-tts-universal (primary) + Web Speech API (fallback)
//
// edge-tts-universal streams Microsoft neural voices from Microsoft's
// servers. No language packs, no API key, works on Edge and Chrome.
// Web Speech API is used as fallback when offline.
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const EDGE_VOICES = {
  'zh-CN': 'zh-CN-XiaoxiaoNeural',
  'ms-MY': 'ms-MY-YasminNeural'
};

let _edgeTTSReady = false;
let _edgeTTSInstance = null;
let _currentAudio = null;

function _initEdgeTTS() {
  try {
    if (typeof EdgeTTS !== 'undefined') {
      _edgeTTSInstance = new EdgeTTS();
      _edgeTTSReady = true;
    }
  } catch(e) { _edgeTTSReady = false; }
}

// Web Speech fallback
let _wsVoiceCache = [];
function _initWebSpeech() {
  if (!window.speechSynthesis) return;
  const load = () => { const v = speechSynthesis.getVoices(); if (v.length) _wsVoiceCache = v; };
  speechSynthesis.onvoiceschanged = load;
  load(); setTimeout(load, 800);
}
_initWebSpeech();

function _pickWebSpeechVoice(lang) {
  const prefix = lang.split('-')[0];
  return _wsVoiceCache.find(v => v.lang === lang)
      || _wsVoiceCache.find(v => v.lang.startsWith(prefix) && v.name.toLowerCase().includes('microsoft'))
      || _wsVoiceCache.find(v => v.lang.startsWith(prefix))
      || null;
}

function _webSpeechFallback(text, lang) {
  if (!window.speechSynthesis) return;
  if (speechSynthesis.paused) speechSynthesis.resume();
  speechSynthesis.cancel();
  setTimeout(() => {
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 0.82; utter.volume = 1.0;
    const voice = _pickWebSpeechVoice(lang);
    if (voice) { utter.voice = voice; utter.lang = voice.lang; }
    else { utter.lang = lang; }
    try { speechSynthesis.speak(utter); } catch(e) {}
  }, 50);
}

async function speak(text, lang) {
  if (_currentAudio) { _currentAudio.pause(); _currentAudio = null; }

  if (_edgeTTSReady && _edgeTTSInstance) {
    const voiceName = EDGE_VOICES[lang] || 'zh-CN-XiaoxiaoNeural';
    try {
      await _edgeTTSInstance.synthesize(text, voiceName, { rate: '-10%' });
      const audioData = _edgeTTSInstance.getAudioData();
      if (audioData && audioData.byteLength > 0) {
        const blob = new Blob([audioData], { type: 'audio/mp3' });
        const url  = URL.createObjectURL(blob);
        const audio = new Audio(url);
        _currentAudio = audio;
        audio.onended = () => URL.revokeObjectURL(url);
        audio.onerror = () => { URL.revokeObjectURL(url); _webSpeechFallback(text, lang); };
        await audio.play();
        return;
      }
    } catch(e) { /* fall through to Web Speech */ }
  }
  _webSpeechFallback(text, lang);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// QUIZ
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startQuiz() {
  const mod = CONTENT[currentLang].modules[currentModuleIdx];
  currentQuizModule = mod;
  navStack.push(() => {
    const m = CONTENT[currentLang].modules[currentModuleIdx];
    renderLearnPage(m);
    showPage('learnPage');
  });

  const allItems = mod.type === 'conditions'
    ? mod.subs.flatMap(s => s.items)
    : mod.items;

  quizQuestions = generateQuizQuestions(allItems, mod, 10);
  quizAnswers = new Array(quizQuestions.length).fill(null);
  renderQuiz();
  showPage('quizPage');
}

function generateQuizQuestions(items, mod, count) {
  const shuffled = [...items].sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, Math.min(count, shuffled.length));
  const langCode = CONTENT[currentLang].lang;

  return selected.map((item, qi) => {
    const isAudio = qi % 3 === 2 && item.t; // every 3rd question is audio-based
    // Generate 3 wrong options from other items
    const wrong = items.filter(x => x.t !== item.t).sort(() => Math.random() - 0.5).slice(0, 3);
    const options = [item, ...wrong].sort(() => Math.random() - 0.5);

    if (isAudio) {
      return {
        type: 'audio',
        prompt: item.t,
        promptLang: langCode,
        question: 'Listen to the audio and select the correct English phrase:',
        answer: item.en,
        options: options.map(o => o.en)
      };
    } else {
      return {
        type: 'mc',
        question: `What is the ${CONTENT[currentLang].label.split(' ')[0]} translation for: "${item.en}"?`,
        answer: item.t,
        options: options.map(o => o.t)
      };
    }
  });
}

function renderQuiz() {
  const mod = currentQuizModule;
  document.getElementById('quizMeta').textContent = `${mod.title} ¬∑ ${quizQuestions.length} Questions`;
  const container = document.getElementById('quizContent');
  container.innerHTML = '';

  quizQuestions.forEach((q, qi) => {
    const card = document.createElement('div');
    card.className = 'question-card';
    card.id = 'q-' + qi;

    let html = `<div class="q-type">${q.type === 'audio' ? 'üîä Audio Question' : 'üìù Multiple Choice'} ¬∑ Q${qi + 1}</div>`;
    html += `<div class="q-text">${q.question}</div>`;

    if (q.type === 'audio') {
      html += `<button class="audio-prompt" onclick="speak('${q.prompt.replace(/'/g, "\\'")}', '${q.promptLang}')">üîä Play Audio</button>`;
    }

    html += `<div class="options" id="opts-${qi}">`;
    q.options.forEach((opt, oi) => {
      html += `<button class="option-btn" id="opt-${qi}-${oi}" onclick="selectAnswer(${qi}, ${oi})">${opt}</button>`;
    });
    html += '</div>';
    card.innerHTML = html;
    container.appendChild(card);
  });

  const nav = document.createElement('div');
  nav.className = 'quiz-nav';
  nav.innerHTML = `<span style="color:var(--muted);font-size:0.85rem;">${quizQuestions.length} questions</span>
    <button id="submitQuizBtn" onclick="submitQuiz()">Submit Quiz ‚úì</button>`;
  container.appendChild(nav);
}

function selectAnswer(qi, oi) {
  const q = quizQuestions[qi];
  quizAnswers[qi] = q.options[oi];
  // Highlight selection
  document.querySelectorAll(`#opts-${qi} .option-btn`).forEach((btn, i) => {
    btn.style.borderColor = i === oi ? 'var(--navy)' : '';
    btn.style.background = i === oi ? '#eef4ff' : '';
  });
}

function submitQuiz() {
  let score = 0;
  quizQuestions.forEach((q, qi) => {
    const opts = document.querySelectorAll(`#opts-${qi} .option-btn`);
    opts.forEach((btn, oi) => {
      btn.disabled = true;
      if (q.options[oi] === q.answer) btn.classList.add('correct');
      else if (q.options[oi] === quizAnswers[qi]) btn.classList.add('wrong');
    });
    if (quizAnswers[qi] === q.answer) score++;
  });

  // Record progress
  const p = getProgress(currentLang, currentQuizModule.id);
  p.quizDone = true;
  p.score = score;

  // Show result after delay
  setTimeout(() => showQuizResult(score, quizQuestions.length), 400);
}

function showQuizResult(score, total) {
  const pct = Math.round((score / total) * 100);
  const container = document.getElementById('quizContent');
  container.innerHTML = `
    <div class="quiz-result">
      <div class="score-circle">${pct}%</div>
      <h3>${score >= 7 ? 'üéâ Well Done!' : score >= 5 ? 'üëç Good Effort!' : 'üí™ Keep Practising!'}</h3>
      <p>You scored <strong>${score} out of ${total}</strong> questions correctly.</p>
      <p style="margin-bottom:20px;">${pct >= 80 ? 'Excellent work! You have mastered this module.' : 'Review the phrases and try again to improve your score.'}</p>
      <button onclick="retakeQuiz()">üîÑ Retake Quiz</button>
      <button onclick="goBackToModule()">üìö Back to Module</button>
    </div>
  `;
}

function retakeQuiz() {
  const p = getProgress(currentLang, currentQuizModule.id);
  p.quizDone = false;
  quizAnswers = new Array(quizQuestions.length).fill(null);
  quizQuestions = generateQuizQuestions(
    currentQuizModule.type === 'conditions'
      ? currentQuizModule.subs.flatMap(s => s.items)
      : currentQuizModule.items,
    currentQuizModule,
    10
  );
  renderQuiz();
}

function goBackToModule() {
  navStack.pop()();
}

// Show banner if both audio engines are unavailable
window.addEventListener('load', () => {
  const hasWebSpeech = !!window.speechSynthesis;
  const hasAudio = typeof Audio !== 'undefined';
  if (!hasWebSpeech && !hasAudio) {
    document.getElementById('audioBanner').style.display = 'block';
  }
});
</script>
</body>
</html>
